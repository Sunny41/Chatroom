<!DOCTYPE>
<html>
    <head>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            window.addEventListener("load", Ready); 
 
            function Ready(){ 
                if(window.File && window.FileReader){
                    document.getElementById('UploadButton').addEventListener('click', StartUpload);  
                    document.getElementById('FileBox').addEventListener('change', FileChosen);
                }
                else
                {
                    document.getElementById('UploadArea').innerHTML = "Your Browser Doesn't Support The File API Please Update Your Browser";
                }
            }

            var SelectedFile;
            function FileChosen(evnt) {
                SelectedFile = evnt.target.files[0];
                var fileType = SelectedFile.type;

                console.log(SelectedFile.name + " " + SelectedFile.type);
                if(fileType.includes('image') || fileType.includes('audio') || fileType.includes('video')){
                    document.getElementById('NameBox').value = SelectedFile.name;
                }else {
                    //Show error
                    removeFile();
                    alert('File type not supported to be sent');
                }
                
            }

            function removeFile(){
                SelectedFile = null;
                document.getElementById('FileBox').value = "";
                document.getElementById('NameBox').value = "";
            }

            var socket = io.connect('http://localhost:3000');
            var FReader;
            var Name;
            function StartUpload(){
                if(document.getElementById('FileBox').value != "")
                {
                    var reader = new FileReader();
                        reader.onload = function(evt){
                            var data ={};
                            data.username = 'jannik';
                            data.file = evt.target.result;
                            data.fileName = document.getElementById('NameBox').value;
                            data.type = SelectedFile.type;
                            data.size = SelectedFile.size;
                            socket.emit('upload file', data);
                        };
                        reader.readAsDataURL(SelectedFile);
                }
                else
                {
                    alert("Please Select A File");
                }
            }

            socket.on('send file', function (data){
                var filenamePath = data.file;
                var filenameDisplay = data.fileName;
                var text = document.createTextNode(data.fileName);

                var node;
                node = document.createElement('a');
                node.href = "javascript:download('data.file')";
                node.appendChild(text);
                /*
                if(data.type.includes('image')){
                    node = document.createElement('img');
                    node.src = data.file;
                    node.width = 240;
                    node.height = 240; 
                }
                else if(data.type.includes('video')){
                    node = document.createElement('video');
                    node.src = data.file;
                    node.autoplay = false;
                    node.controls = true;
                    node.height = 240;
                    node.width = 240;
                    
                }else if(data.type.includes('audio')){
                    node = document.createElement('audio');
                    node.autoplay = false;
                    node.controls = true;
                }
                */
                document.getElementById('file').appendChild(node);
            });

            function download(file)
            {
                ifrm = document.getElementById('iframe');
                ifrm.src = file;
            }

        </script>
        

    </head>
    <body> 
        <div id="UploadBox">
            <h2>Video Uploader</h2>
            <span id='UploadArea'>
                <label for="FileBox">Choose A File: </label><input type="file" id="FileBox"><br>
                <label for="NameBox">Name: </label><input type="text" id="NameBox"><br>
     
                <button  type='button' id='UploadButton' class='Button'>Upload</button>
            </span>
        </div>

        <iframe id="iframe" style="display:none;"></iframe>

        <div id="file">
            
        </div>
    </body>
</html>